import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.sql.*;
import org.apache.commons.lang3.StringEscapeUtils;


@WebServlet("/servlet/Authen")
public class Authen extends HttpServlet {
    public void service(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
	PrintWriter out = res.getWriter();
	
	res.setContentType("text/html");
	out.println("<html><head><meta charset=UTF-8>");
	out.println("<link rel=stylesheet type=text/css href=style.css>");
	out.println("<title>Test Mdp</title></head>");
	out.println("<body><center>");
	out.println("<h1>Login :</h1>");

	Connection con=null;
	try {
	    String login=StringEscapeUtils.escapeHtml4(req.getParameter("login"));
	    String mdp=StringEscapeUtils.escapeHtml4(req.getParameter("mdp"));
	    // enregistrement du driver
	    Class.forName("org.postgresql.Driver");
	    
	    // connexion a la base
	    con = DriverManager.getConnection("jdbc:postgresql://psqlserv/n2p1?allowMultiQueries=true","bonnardm","moi");
	    
	    // execution de la requete
	    PreparedStatement ps = con.prepareStatement("select * from users where login=? and mdp=? ");
	    ps.setString(1,login);
	    ps.setString(2,mdp);
	    ResultSet rs = ps.executeQuery();
	    if(rs.next()) {
		HttpSession session = req.getSession(true);
		// les autres pages devront tester la presence de login pour savoir si on a bien ete authentifie
		Personne p = new Personne(rs.getString("login"),rs.getString("mdp"));
		session.setAttribute("login", p);
		con.close();
		res.sendRedirect("Menu");
	    } else { 
		con.close();
		out.println("Login/mdp incorrect");
	    }
	    
	    out.println("</center></body>");
	}
	catch (Exception e) {
	    out.println("Erreur : " + e);
	}
	finally
	    {
		try{con.close();} catch (Exception e){}
	    }
    }
}
